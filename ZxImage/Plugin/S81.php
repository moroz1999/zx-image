<?php
declare(strict_types=1);


namespace ZxImage\Plugin;

use InvalidArgumentException;

class S81 extends Standard
{
    protected function loadBits(): ?array
    {
        $tokens = [];
        if ($this->makeHandle()) {
            while (($bin = $this->readByte()) !== null) {
                $tokens[] = $bin;
            }
            return $this->parseTokens($tokens);
        }
        return null;
    }

    private function parseTokens(array $tokens): array
    {
        $pixelsArray = [];
        $attributesArray = [];
        $currentAttribute = '00111000';
        $attrX = 0;
        $attrY = 0;

        foreach ($tokens as $token) {
            $charData = static::getChar($token);
            $attributesArray[$attrY * 32 + $attrX] = $currentAttribute;
            foreach ($charData as $row => $pixels) {
                $base = 0;
                if ($attrY > 15) {
                    $base = 32 * 8 * 16;
                } elseif ($attrY > 7) {
                    $base = 32 * 8 * 8;
                }

                $pixelY = $base + $attrY * 32 + $row * 256;
                $pixelX = $attrX;
                $pixelsArray[$pixelY + $pixelX] = $pixels;
            }
            $attrX++;
            if ($attrX === 32) {
                $attrX = 0;
                $attrY++;
            }
        }
        ksort($pixelsArray);
        ksort($attributesArray);
        return compact('pixelsArray', 'attributesArray');
    }

    protected static function getChar(int $token): array
    {
        return Zx81FontData::getChar($token);
    }
}

class Zx81FontData
{
    private static array $data = [
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '10101010',
            '01010101',
            '10101010',
            '01010101',
            '10101010',
            '01010101',
            '10101010',
            '01010101',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '10101010',
            '01010101',
            '10101010',
            '01010101',
        ],
        [
            '10101010',
            '01010101',
            '10101010',
            '01010101',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00100100',
            '00100100',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00011100',
            '00100010',
            '01111000',
            '00100000',
            '00100000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '00001000',
            '00111110',
            '00101000',
            '00111110',
            '00001010',
            '00111110',
            '00001000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00010000',
            '00000000',
            '00000000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00000100',
            '00001000',
            '00000000',
            '00001000',
            '00000000',
        ],
        [
            '00000000',
            '00000100',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00000100',
            '00000000',
        ],
        [
            '00000000',
            '00100000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00100000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00010000',
            '00001000',
            '00000100',
            '00001000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000100',
            '00001000',
            '00010000',
            '00001000',
            '00000100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00111110',
            '00000000',
            '00111110',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00001000',
            '00001000',
            '00111110',
            '00001000',
            '00001000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00111110',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00010100',
            '00001000',
            '00111110',
            '00001000',
            '00010100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000010',
            '00000100',
            '00001000',
            '00010000',
            '00100000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00010000',
            '00000000',
            '00000000',
            '00010000',
            '00010000',
            '00100000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00001000',
            '00001000',
            '00010000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00011000',
            '00011000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000110',
            '01001010',
            '01010010',
            '01100010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00011000',
            '00101000',
            '00001000',
            '00001000',
            '00001000',
            '00111110',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00000010',
            '00111100',
            '01000000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00001100',
            '00000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00001000',
            '00011000',
            '00101000',
            '01001000',
            '01111110',
            '00001000',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '01000000',
            '01111100',
            '00000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000000',
            '01111100',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '00000010',
            '00000100',
            '00001000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00111100',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '00111110',
            '00000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '01111110',
            '01000010',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '01111100',
            '01000010',
            '01111100',
            '01000010',
            '01000010',
            '01111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000000',
            '01000000',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111000',
            '01000100',
            '01000010',
            '01000010',
            '01000100',
            '01111000',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '01000000',
            '01111100',
            '01000000',
            '01000000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '01000000',
            '01111100',
            '01000000',
            '01000000',
            '01000000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000000',
            '01001110',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01111110',
            '01000010',
            '01000010',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '00111110',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00111110',
            '00000000',
        ],
        [
            '00000000',
            '00000010',
            '00000010',
            '00000010',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01000100',
            '01001000',
            '01110000',
            '01001000',
            '01000100',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '01000000',
            '01000000',
            '01000000',
            '01000000',
            '01000000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01100110',
            '01011010',
            '01000010',
            '01000010',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01100010',
            '01010010',
            '01001010',
            '01000110',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111100',
            '01000010',
            '01000010',
            '01111100',
            '01000000',
            '01000000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '01010010',
            '01001010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111100',
            '01000010',
            '01000010',
            '01111100',
            '01000100',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000000',
            '00111100',
            '00000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '11111110',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '00100100',
            '00011000',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '01011010',
            '00100100',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '00100100',
            '00011000',
            '00011000',
            '00100100',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '10000010',
            '01000100',
            '00101000',
            '00010000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '00000100',
            '00001000',
            '00010000',
            '00100000',
            '01111110',
            '00000000',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '01010101',
            '10101010',
            '01010101',
            '10101010',
            '01010101',
            '10101010',
            '01010101',
            '10101010',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '01010101',
            '10101010',
            '01010101',
            '10101010',
        ],
        [
            '01010101',
            '10101010',
            '01010101',
            '10101010',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '11111111',
            '11011011',
            '11011011',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '11111111',
            '11100011',
            '11011101',
            '10000111',
            '11011111',
            '11011111',
            '10000001',
            '11111111',
        ],
        [
            '11111111',
            '11110111',
            '11000001',
            '11010111',
            '11000001',
            '11110101',
            '11000001',
            '11110111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11101111',
            '11111111',
            '11111111',
            '11101111',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '11111011',
            '11110111',
            '11111111',
            '11110111',
            '11111111',
        ],
        [
            '11111111',
            '11111011',
            '11110111',
            '11110111',
            '11110111',
            '11110111',
            '11111011',
            '11111111',
        ],
        [
            '11111111',
            '11011111',
            '11101111',
            '11101111',
            '11101111',
            '11101111',
            '11011111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11101111',
            '11110111',
            '11111011',
            '11110111',
            '11101111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11111011',
            '11110111',
            '11101111',
            '11110111',
            '11111011',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11000001',
            '11111111',
            '11000001',
            '11111111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11110111',
            '11110111',
            '11000001',
            '11110111',
            '11110111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11000001',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11101011',
            '11110111',
            '11000001',
            '11110111',
            '11101011',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11111101',
            '11111011',
            '11110111',
            '11101111',
            '11011111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11101111',
            '11111111',
            '11111111',
            '11101111',
            '11101111',
            '11011111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11110111',
            '11110111',
            '11101111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11100111',
            '11100111',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111001',
            '10110101',
            '10101101',
            '10011101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '11100111',
            '11010111',
            '11110111',
            '11110111',
            '11110111',
            '11000001',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '11111101',
            '11000011',
            '10111111',
            '10000001',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '11110011',
            '11111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '11110111',
            '11100111',
            '11010111',
            '10110111',
            '10000001',
            '11110111',
            '11111111',
        ],
        [
            '11111111',
            '10000001',
            '10111111',
            '10000011',
            '11111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111111',
            '10000011',
            '10111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '10000001',
            '11111101',
            '11111011',
            '11110111',
            '11101111',
            '11101111',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '11000011',
            '10111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '10111101',
            '11000001',
            '11111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '10111101',
            '10000001',
            '10111101',
            '10111101',
            '11111111',
        ],
        [
            '11111111',
            '10000011',
            '10111101',
            '10000011',
            '10111101',
            '10111101',
            '10000011',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '10111111',
            '10111111',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '10000111',
            '10111011',
            '10111101',
            '10111101',
            '10111011',
            '10000111',
            '11111111',
        ],
        [
            '11111111',
            '10000001',
            '10111111',
            '10000011',
            '10111111',
            '10111111',
            '10000001',
            '11111111',
        ],
        [
            '11111111',
            '10000001',
            '10111111',
            '10000011',
            '10111111',
            '10111111',
            '10111111',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '10111111',
            '10110001',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '10111101',
            '10111101',
            '10000001',
            '10111101',
            '10111101',
            '10111101',
            '11111111',
        ],
        [
            '11111111',
            '11000001',
            '11110111',
            '11110111',
            '11110111',
            '11110111',
            '11000001',
            '11111111',
        ],
        [
            '11111111',
            '11111101',
            '11111101',
            '11111101',
            '10111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '10111011',
            '10110111',
            '10001111',
            '10110111',
            '10111011',
            '10111101',
            '11111111',
        ],
        [
            '11111111',
            '10111111',
            '10111111',
            '10111111',
            '10111111',
            '10111111',
            '10000001',
            '11111111',
        ],
        [
            '11111111',
            '10111101',
            '10011001',
            '10100101',
            '10111101',
            '10111101',
            '10111101',
            '11111111',
        ],
        [
            '11111111',
            '10111101',
            '10011101',
            '10101101',
            '10110101',
            '10111001',
            '10111101',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '10111101',
            '10111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '10000011',
            '10111101',
            '10111101',
            '10000011',
            '10111111',
            '10111111',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111101',
            '10111101',
            '10101101',
            '10110101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '10000011',
            '10111101',
            '10111101',
            '10000011',
            '10111011',
            '10111101',
            '11111111',
        ],
        [
            '11111111',
            '11000011',
            '10111111',
            '11000011',
            '11111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '00000001',
            '11101111',
            '11101111',
            '11101111',
            '11101111',
            '11101111',
            '11111111',
        ],
        [
            '11111111',
            '10111101',
            '10111101',
            '10111101',
            '10111101',
            '10111101',
            '11000011',
            '11111111',
        ],
        [
            '11111111',
            '10111101',
            '10111101',
            '10111101',
            '10111101',
            '11011011',
            '11100111',
            '11111111',
        ],
        [
            '11111111',
            '10111101',
            '10111101',
            '10111101',
            '10111101',
            '10100101',
            '11011011',
            '11111111',
        ],
        [
            '11111111',
            '10111101',
            '11011011',
            '11100111',
            '11100111',
            '11011011',
            '10111101',
            '11111111',
        ],
        [
            '11111111',
            '01111101',
            '10111011',
            '11010111',
            '11101111',
            '11101111',
            '11101111',
            '11111111',
        ],
        [
            '11111111',
            '10000001',
            '11111011',
            '11110111',
            '11101111',
            '11011111',
            '10000001',
            '11111111',
        ],
    ];

    public static function getChar(int $number): array
    {
        if ($number > 0 && $number < 64) {
            return self::$data[$number];
        }
        if ($number > 127 && $number < 192) {
            return self::$data[$number - 64];
        }
        return self::$data[0];
    }
}


