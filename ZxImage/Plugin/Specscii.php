<?php
declare(strict_types=1);


namespace ZxImage\Plugin;

use InvalidArgumentException;

class Specscii extends Standard
{
    protected function loadBits(): ?array
    {
        $tokens = [];
        if ($this->makeHandle()) {
            while (($bin = $this->readByte()) !== null) {
                $tokens[] = $bin;
            }
            return $this->parseTokens($tokens);
        }
        return null;
    }

    private function parseTokens(array $tokens): array
    {
        $pixelsArray = [];
        $attributesArray = [];
        $currentAttribute = '00000000';
        $command = null;
        $nextCommand = null;
        $attrX = 0;
        $attrY = 0;

        foreach ($tokens as $token) {
            if (!$command) {
                switch ($token) {
                    case Chr::INK->value:
                    case Chr::PAPER->value:
                    case Chr::FLASH->value:
                    case Chr::BRIGHT->value:
                        $nextCommand = $token;
                        break;
                }
            }
            if ($command) {
                //switch color
                switch ($command) {
                    case Chr::INK->value:
                        $color = $this->toBinaryString($token);
                        $currentAttribute = substr_replace($currentAttribute, $color, 5, 3);
                        break;
                    case Chr::PAPER->value:
                        $color = $this->toBinaryString($token);
                        $currentAttribute = substr_replace($currentAttribute, $color, 2, 3);
                        break;
                    case Chr::FLASH->value:
                        $currentAttribute[0] = $token === 1 ? '1' : '0';
                        break;
                    case Chr::BRIGHT->value:
                        $currentAttribute[1] = $token === 1 ? '1' : '0';
                        break;
                }
                $command = null;
            } elseif ($nextCommand === null) {
                $charData = FontData::getChar($token - 32);
                $attributesArray[$attrY * 32 + $attrX] = $currentAttribute;
                foreach ($charData as $row => $pixels) {
                    $base = 0;
                    if ($attrY > 15) {
                        $base = 32 * 8 * 16;
                    } elseif ($attrY > 7) {
                        $base = 32 * 8 * 8;
                    }

                    $pixelY = $base + $attrY * 32 + $row * 256;
                    $pixelX = $attrX;
                    $pixelsArray[$pixelY + $pixelX] = $pixels;
                }
                $attrX++;
                if ($attrX === 32) {
                    $attrX = 0;
                    $attrY++;
                }
            } else {
                $command = $nextCommand;
                $nextCommand = null;
            }
        }
        ksort($pixelsArray);
        ksort($attributesArray);
        return compact('pixelsArray', 'attributesArray');
    }

    private function toBinaryString($number): string
    {
        if ($number < 0 || $number > 7) {
            throw new InvalidArgumentException("Invalid range");
        }
        return str_pad(decbin($number), 3, '0', STR_PAD_LEFT);
    }
}

enum Chr: int
{
    case INK = 16;
    case PAPER = 17;
    case FLASH = 18;
    case BRIGHT = 19;
    case INVERSE = 20;
    case OVER = 21;
}

class FontData
{
    private static array $data = [
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00000000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00100100',
            '00100100',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00100100',
            '01111110',
            '00100100',
            '00100100',
            '01111110',
            '00100100',
            '00000000',
        ],
        [
            '00000000',
            '00001000',
            '00111110',
            '00101000',
            '00111110',
            '00001010',
            '00111110',
            '00001000',
        ],
        [
            '00000000',
            '01100010',
            '01100100',
            '00001000',
            '00010000',
            '00100110',
            '01000110',
            '00000000',
        ],
        [
            '00000000',
            '00010000',
            '00101000',
            '00010000',
            '00101010',
            '01000100',
            '00111010',
            '00000000',
        ],
        [
            '00000000',
            '00001000',
            '00010000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00000100',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00000100',
            '00000000',
        ],
        [
            '00000000',
            '00100000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00100000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00010100',
            '00001000',
            '00111110',
            '00001000',
            '00010100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00001000',
            '00001000',
            '00111110',
            '00001000',
            '00001000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00001000',
            '00001000',
            '00010000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00111110',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00011000',
            '00011000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000010',
            '00000100',
            '00001000',
            '00010000',
            '00100000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000110',
            '01001010',
            '01010010',
            '01100010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00011000',
            '00101000',
            '00001000',
            '00001000',
            '00001000',
            '00111110',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00000010',
            '00111100',
            '01000000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00001100',
            '00000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00001000',
            '00011000',
            '00101000',
            '01001000',
            '01111110',
            '00001000',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '01000000',
            '01111100',
            '00000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000000',
            '01111100',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '00000010',
            '00000100',
            '00001000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00111100',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '00111110',
            '00000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00010000',
            '00000000',
            '00000000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00010000',
            '00000000',
            '00000000',
            '00010000',
            '00010000',
            '00100000',
        ],
        [
            '00000000',
            '00000000',
            '00000100',
            '00001000',
            '00010000',
            '00001000',
            '00000100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00111110',
            '00000000',
            '00111110',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00010000',
            '00001000',
            '00000100',
            '00001000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '00000100',
            '00001000',
            '00000000',
            '00001000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01001010',
            '01010110',
            '01011110',
            '01000000',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '01111110',
            '01000010',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '01111100',
            '01000010',
            '01111100',
            '01000010',
            '01000010',
            '01111100',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000000',
            '01000000',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111000',
            '01000100',
            '01000010',
            '01000010',
            '01000100',
            '01111000',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '01000000',
            '01111100',
            '01000000',
            '01000000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '01000000',
            '01111100',
            '01000000',
            '01000000',
            '01000000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000000',
            '01001110',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01111110',
            '01000010',
            '01000010',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '00111110',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00111110',
            '00000000',
        ],
        [
            '00000000',
            '00000010',
            '00000010',
            '00000010',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01000100',
            '01001000',
            '01110000',
            '01001000',
            '01000100',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '01000000',
            '01000000',
            '01000000',
            '01000000',
            '01000000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01100110',
            '01011010',
            '01000010',
            '01000010',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01100010',
            '01010010',
            '01001010',
            '01000110',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111100',
            '01000010',
            '01000010',
            '01111100',
            '01000000',
            '01000000',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000010',
            '01000010',
            '01010010',
            '01001010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01111100',
            '01000010',
            '01000010',
            '01111100',
            '01000100',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '00111100',
            '01000000',
            '00111100',
            '00000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '11111110',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '00100100',
            '00011000',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '01000010',
            '01000010',
            '01000010',
            '01011010',
            '00100100',
            '00000000',
        ],
        [
            '00000000',
            '01000010',
            '00100100',
            '00011000',
            '00011000',
            '00100100',
            '01000010',
            '00000000',
        ],
        [
            '00000000',
            '10000010',
            '01000100',
            '00101000',
            '00010000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '01111110',
            '00000100',
            '00001000',
            '00010000',
            '00100000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '00001110',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00001110',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01000000',
            '00100000',
            '00010000',
            '00001000',
            '00000100',
            '00000000',
        ],
        [
            '00000000',
            '01110000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '01110000',
            '00000000',
        ],
        [
            '00000000',
            '00010000',
            '00111000',
            '01010100',
            '00010000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '11111111',
        ],
        [
            '00000000',
            '00011100',
            '00100010',
            '01111000',
            '00100000',
            '00100000',
            '01111110',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00111000',
            '00000100',
            '00111100',
            '01000100',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00100000',
            '00100000',
            '00111100',
            '00100010',
            '00100010',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00011100',
            '00100000',
            '00100000',
            '00100000',
            '00011100',
            '00000000',
        ],
        [
            '00000000',
            '00000100',
            '00000100',
            '00111100',
            '01000100',
            '01000100',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00111000',
            '01000100',
            '01111000',
            '01000000',
            '00111100',
            '00000000',
        ],
        [
            '00000000',
            '00001100',
            '00010000',
            '00011000',
            '00010000',
            '00010000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00111100',
            '01000100',
            '01000100',
            '00111100',
            '00000100',
            '00111000',
        ],
        [
            '00000000',
            '01000000',
            '01000000',
            '01111000',
            '01000100',
            '01000100',
            '01000100',
            '00000000',
        ],
        [
            '00000000',
            '00010000',
            '00000000',
            '00110000',
            '00010000',
            '00010000',
            '00111000',
            '00000000',
        ],
        [
            '00000000',
            '00000100',
            '00000000',
            '00000100',
            '00000100',
            '00000100',
            '00100100',
            '00011000',
        ],
        [
            '00000000',
            '00100000',
            '00101000',
            '00110000',
            '00110000',
            '00101000',
            '00100100',
            '00000000',
        ],
        [
            '00000000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00010000',
            '00001100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01101000',
            '01010100',
            '01010100',
            '01010100',
            '01010100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01111000',
            '01000100',
            '01000100',
            '01000100',
            '01000100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00111000',
            '01000100',
            '01000100',
            '01000100',
            '00111000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01111000',
            '01000100',
            '01000100',
            '01111000',
            '01000000',
            '01000000',
        ],
        [
            '00000000',
            '00000000',
            '00111100',
            '01000100',
            '01000100',
            '00111100',
            '00000100',
            '00000110',
        ],
        [
            '00000000',
            '00000000',
            '00011100',
            '00100000',
            '00100000',
            '00100000',
            '00100000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00111000',
            '01000000',
            '00111000',
            '00000100',
            '01111000',
            '00000000',
        ],
        [
            '00000000',
            '00010000',
            '00111000',
            '00010000',
            '00010000',
            '00010000',
            '00001100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01000100',
            '01000100',
            '01000100',
            '01000100',
            '00111000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01000100',
            '01000100',
            '00101000',
            '00101000',
            '00010000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01000100',
            '01010100',
            '01010100',
            '01010100',
            '00101000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01000100',
            '00101000',
            '00010000',
            '00101000',
            '01000100',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '01000100',
            '01000100',
            '01000100',
            '00111100',
            '00000100',
            '00111000',
        ],
        [
            '00000000',
            '00000000',
            '01111100',
            '00001000',
            '00010000',
            '00100000',
            '01111100',
            '00000000',
        ],
        [
            '00000000',
            '00001110',
            '00001000',
            '00110000',
            '00001000',
            '00001000',
            '00001110',
            '00000000',
        ],
        [
            '00000000',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00001000',
            '00000000',
        ],
        [
            '00000000',
            '01110000',
            '00010000',
            '00001100',
            '00010000',
            '00010000',
            '01110000',
            '00000000',
        ],
        [
            '00000000',
            '00010100',
            '00101000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00111100',
            '01000010',
            '10011001',
            '10100001',
            '10100001',
            '10011001',
            '01000010',
            '00111100',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '00000000',
            '00000000',
            '00000000',
            '00000000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '00001111',
            '00001111',
            '00001111',
            '00001111',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11110000',
            '11110000',
            '11110000',
            '11110000',
        ],
        [
            '00000000',
            '00000000',
            '00000000',
            '00000000',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '00001111',
            '00001111',
            '00001111',
            '00001111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '11110000',
            '11110000',
            '11110000',
            '11110000',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
        [
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
            '11111111',
        ],
    ];

    public static function getChar($number): array
    {
        return self::$data[$number];
    }
}